# Authentication Process Documentation

## Overview

This document explains how users are authenticated in our application. It covers the flow from the initial login request to token validation and session management.

Our authentication system relies on **Shopify OAuth**, meaning we use Shopify's secure login system to verify users and grant access to our app.

---

## How It Works: Step-by-Step

### 1. The Login Request (Frontend)
When a user opens our app in their Shopify admin:
1.  **Check Status**: The app (specifically `pages/index.jsx`) checks if the user is already logged in and has a valid session.
2.  **Redirect if Needed**: If the user is not logged in or their session has expired, the app automatically redirects them to our authentication endpoint: `/api/auth`.

### 2. Starting the Auth Flow (Backend)
**File:** `pages/api/auth/index.js`

This is the entry point for authentication.
1.  **Identify Shop**: The backend looks for the `shop` parameter (e.g., `store-name.myshopify.com`) to know which store is trying to log in.
2.  **Initiate OAuth**: We call `shopify.auth.begin`, which redirects the user to Shopify's permission screen. This is where the merchant approves our app's access scopes.

### 3. Token Exchange & Validation
**Files:** `pages/api/auth/tokens.js` & `pages/api/auth/callback.js`

Once the user approves the app, Shopify sends them back to us with a temporary **authorization code**.

1.  **First Callback (`/api/auth/tokens`)**:
    -   We receive the code from Shopify.
    -   We exchange this code for a permanent **Access Token**.
    -   We register **Webhooks** (notifications from Shopify, like "app uninstalled").
    -   *Note: We then trigger a secondary internal redirect to finalize the session.*

2.  **Final Callback (`/api/auth/callback`)**:
    -   We receive the final confirmation.
    -   **Session Storage**: We save the user's session (including the Access Token) in our database. This allows us to remember them for future requests.
    -   **User Creation/Update**: We check our database for this shop.
        -   **New User**: We create a new entry in our `users` table and log the installation (e.g., to Slack).
        -   **Existing User**: We update their details and check if their subscription or trial needs adjustment.

### 4. Post-Authentication
**File:** `pages/api/auth/afterAuth.js`

After the session is secured, we perform housekeeping:
-   Fetch shop details (email, owner name, etc.) from Shopify.
-   Sync this data to our database.
-   If it's a new user, we might fetch initial data (like order counts) to personalize their experience.

Finally, the user is redirected back to the **Home Page** (`/`), where they now have a valid session and can access the app.

---

## Technical Details

### Token Generation & Storage
-   **Generation**: Tokens are generated by Shopify during the OAuth process. We do not create them ourselves; we only request them.
-   **Storage**: We store sessions in our database using **Prisma** (a database tool).
    -   **Table**: `shopify_sessions`
    -   **Key Data**: `shop`, `accessToken`, `scope`, `expires`.
-   **Security**: The Access Token is the key to the user's shop data. It is stored securely and never shared with the frontend client directly.

### Request Validation (Middleware)
**File:** `utils/middleware/verifyRequest.js`

Every time the frontend makes a request to our backend API (e.g., to save settings), we validate it:
1.  **Check Header/Cookie**: We look for a session token or cookie.
2.  **Verify Session**: We check if the session exists in our database and hasn't expired.
3.  **Verify Scopes**: We ensure the user has granted all currently required permissions.
4.  **Result**:
    -   **Valid**: The request is allowed to proceed.
    -   **Invalid**: The request is blocked (403 or 401 error), and the frontend is told to re-authenticate (redirect to login).

### Token Expiry
-   **Offline Tokens**: Currently, we often use "offline" access tokens which do not expire unless the user uninstalls the app or we rotate our API secrets.
-   **Online Tokens** (if used): These expire quickly (e.g., 24 hours) and require frequent refreshing.
-   **Handling Expiry**: If a token is invalid/expired, our middleware detects it and forces the user to go through the login flow (Step 1) again to get a fresh token.

---

## Frontend vs. Backend Responsibilities

| Feature | Frontend (`pages/index.jsx`) | Backend (`pages/api/*`) |
| :--- | :--- | :--- |
| **Role** | UI & User Interaction | Logic, Data & Security |
| **Auth Check** | Checks if `redirect` flag is set by server. | Validates session tokens on every API call. |
| **Action** | Redirects browser to `/api/auth`. | Exchanges codes for tokens, talks to DB. |
| **Secrets** | Has NO access to API secrets or tokens. | Holds API Keys, Secrets, and Access Tokens. |

---

## Glossary
-   **OAuth**: The open standard for access delegation (how we log in).
-   **Access Token**: The "key" Shopify gives us to access a shop's data.
-   **Scope**: The specific permissions we ask for (e.g., `read_products`, `write_orders`).
-   **Session**: A record of a logged-in user, stored in our database.
-   **Middleware**: Code that runs *before* our main API logic to check security.
